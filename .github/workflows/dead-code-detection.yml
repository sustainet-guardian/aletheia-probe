name: Dead Code Detection

on:
  # Run weekly on Saturdays at 4 AM UTC
  schedule:
    - cron: '0 4 * * 6'
  # Allow manual triggering
  workflow_dispatch:

jobs:
  dead-code-detection:
    name: Dead Code Detection
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]

    - name: Run dead code detection
      id: dead-code-check
      run: |
        python scripts/detect-dead-code.py > dead-code-report.txt 2>&1
      continue-on-error: true

    - name: Archive dead code detection results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dead-code-detection-results
        path: dead-code-report.txt
        retention-days: 30

    - name: Create issue on dead code detection
      if: steps.dead-code-check.outcome == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let reportContent = '';
          try {
            reportContent = fs.readFileSync('dead-code-report.txt', 'utf8');
          } catch (error) {
            reportContent = 'Could not read dead code detection report.';
          }

          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'Dead Code Detected - ' + new Date().toISOString().split('T')[0],
            body: `The weekly dead code detection has identified potentially unused functions.

            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ## Dead Code Report

            \`\`\`
            ${reportContent}
            \`\`\`

            Please review the identified functions and either:
            1. Remove them if they are truly unused
            2. Mark them with \`@code_is_used\` decorator if they are used but not detected by runtime tracing (e.g., polymorphic methods, decorator-replaced methods, etc.)

            See the script documentation in \`scripts/detect-dead-code.py\` for more details on when to use the \`@code_is_used\` decorator.

            [AI-assisted]`,
            labels: ['maintenance', 'automated', 'dead-code']
          });
          console.log('Created issue:', issue.data.html_url);